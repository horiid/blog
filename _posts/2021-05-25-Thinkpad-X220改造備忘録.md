---
layout : post
---
## 概要
Thinkpad X220改造備忘録的な何か。LenovoのBIOSからフリーソフトウェアのCorebootを導入した話。

---
## Corebootインストール手順
ラズパイを使ってチップをROM焼き。ジャンパーとICテストクリップとか用意してPCをバラす。

### 使用PC
Lenovo Thinkpad X220。他の機種で正常に動作するかは不明なため、バックアップを用意した上でそこは自己責任。

### Raspberry Pi 
flashromコマンドでROM焼きする。モデルはModel 3B+を使ったけどなんでもいいと思う。

### ICテストクリップ
X220の場合：SOIC 8-pin ICテストクリップ。

### メス-メスジャンパ
クリップとラズパイを繋ぐ。

## Raspberry Piセットアップ
次を順番に実施。

### アプデ（基本だね）
~~~
sudo apt update
~~~
### flashromインスコ
~~~
sudo apt install flashrom
~~~
### 依存関係の解消
~~~
sudo apt install build-essential git libftdi1 libftdi-dev libusb-dev \
libpci-dev m4 bison flex libncurses5-dev libncurses5 pciutils \
usbutils libpci-dev libusb-dev zlib1g-dev libusb-1.0 gnat-4.9
~~~
### CorebootリポジトリClone
~~~
clone --recurse-submodules https://review.coreboot.org/coreboot.git ~/coreboot
~~~
### ifdtoolのmake
~~~
cd ~/coreboot/util/ifdtool
make & sudo make install
~~~

### me_cleanerインスコ(推奨)
~~~
git clone https://github.com/corna/me_cleaner ~/me_cleaner
~~~

### Rasberry PiのPin構成
書き込むチップに合わせる必要があるので、製品メーカーのHPとかで調べる。

## Flashrom
### aliasの設定
次のコマンドは何度か使用するので、aliasで手間を省く。
~~~ 
alias fr=`sudo flashrom -p linux_spi:dev=/dev/spidev0.0,spispeed=1024`
~~~

### ROMチップの認識
~~~
# Identify all chips
fr
~~~

### ROM読み込み
バックアップとして、ROMから書き込み前のファームウェアを控えておく。念のため数回実施して置くと安心（次セクションのチェックサムに関連）。
~~~
fr -c "your chip name" -r backup01.bin
fr -c "your chip name" -r backup02.bin
fr -c "your chip name" -r backup03.bin
fr -c "your chip name" -r backup04.bin
~~~

### チェックサム確認
チェックサムが合わなければクリップの接触不良など何らかの問題がある。チェックサムが合わなければ、接触などを確認の上再トライする。 __書き込み後にPCが立ち上がらない可能性を踏まえ、バックアップのファームウェアは必ず控えておく。__
~~~
md5sum backup01.bin backup02.bin backup03.bin backup04.bin
~~~

### me_cleanerの実行
me_cleanerはIntel ME(Management Engine)を無効化するもの。MEはファームウェアでユーザランドやOSよりも高い権限で動くため通常は手が出せないが、こいつがやってくれるらしい（本当か？）
~~~
~/me_cleaner/me_cleaner.py -S backup01.bin
~~~

### ifdtool実行
~~~
ifdtool -x backup01.bin
~~~

### 取り出したバイナリの移動
~~~
mkdir -p ~/coreboot/3rdparty/blobs/mainboard/lenovo/x220
cd $_ 
cp path/to/blobs/flashregion_0_flashdescriptor.bin descriptor.bin
cp path/to/blobs/flashregion_2_intel_me.bin me.bin
cp path/to/blobs/flashregion_3_gbe.bin gbe.bin
~~~

## Corebootビルド
### Config
"make menuconfig"でcorebootのconfigメニューが立ち上がる。選択肢は次を選択したが、環境に合わせ好きなのを選ぶ。
~~~
make menuconfig

# Coreboot configuration
General
    [*]Compress ramstage with LZMA
    [*] Include coreboot .config file into the ROM image
    [*] Allow use of binary-only repository

Mainboard
    Mainboard vendor (Select your hardware vendor)
    Mainboard model (Select your model)

Chipset
    [*] Enable VMX for virtualization
    [*] Add Intel descriptor.bin file
    [*] Add Intel ME/TXE firmware
    [*] Add gigabit ethernet firmware

# If using VGABIOS
Devices
    [*] Graphics initialization (Run VGA Option ROMs)
    [*] Add a VGA BIOS image
    [*] Add a Video Bios Table (VBT) binary to CBFS

Generic Drivers
    [*] PS/2 keyboard init

Console
    [*] Show POST codes on the debug console

Payload
    Add a payload (SeaBIOS) --->
    SeaBIOS version (master) --->
    [*] Hardware init during option ROM execution
~~~

### Corebootのビルド
ROMに書き込むBIOSが出来上がる。
~~~
make
~~~
Raspberry Piで実行しているなら以下の手順でやる。
~~~
make crossgcc-i386 CPUS=4
make iasl
make
~~~

## Coreboot書き込み
いよいよ書き込む。
~~~
cd ~/coreboot/build
fr -c "your chip name" -w coreboot.rom
~~~
少し待った後、以下の表示が出れば成功（なはず）
~~~
Verifying flash... VERIFIED.
~~~

* うまく行ったら、ラズパイの電源を切ってからクリップを外す。
* ダメだったら、接触確認して再トライ。
* まだダメだったら、Corebootの設定を見直して再ビルドしてから再トライしてみる。
* それでもダメなら、初めにとっておいたバックアップを書き込む。用意しておいてよかったね。